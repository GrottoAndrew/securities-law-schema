<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compliance Evidence Locker Dashboard</title>
  <style>
    :root {
      --primary: #2563eb;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-600: #4b5563;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--gray-50);
      color: var(--gray-800);
      line-height: 1.5;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { font-size: 20px; font-weight: 600; color: var(--gray-900); }

    .header-controls { display: flex; align-items: center; gap: 16px; }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.green { background: #dcfce7; color: #166534; }
    .status-badge.yellow { background: #fef9c3; color: #854d0e; }
    .status-badge.red { background: #fee2e2; color: #991b1b; }
    .status-badge.blue { background: #dbeafe; color: #1e40af; }

    /* Jurisdiction Toggle */
    .jurisdiction-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px;
      background: var(--gray-100);
      border-radius: 8px;
    }

    .jurisdiction-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .jurisdiction-btn.active {
      background: white;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .jurisdiction-btn.sec.active { color: #1e40af; }
    .jurisdiction-btn.gdpr.active { color: #7c3aed; }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: white;
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow: auto;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-header.warning { background: #fef3c7; }
    .modal-header.danger { background: #fee2e2; }

    .modal-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .modal-icon.warning { background: #fbbf24; }
    .modal-icon.danger { background: #ef4444; color: white; }

    .modal-title { font-size: 18px; font-weight: 600; }
    .modal-subtitle { font-size: 13px; color: var(--gray-600); }

    .modal-body { padding: 24px; }

    .conflict-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 13px;
    }

    .conflict-table th, .conflict-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--gray-200);
    }

    .conflict-table th { background: var(--gray-50); font-weight: 600; }

    .conflict-table .sec-col { background: #eff6ff; }
    .conflict-table .gdpr-col { background: #f5f3ff; }

    .conflict-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .conflict-badge.conflict { background: #fee2e2; color: #991b1b; }
    .conflict-badge.ok { background: #dcfce7; color: #166534; }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--gray-200);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-secondary { background: var(--gray-100); color: var(--gray-800); }
    .btn-secondary:hover { background: var(--gray-200); }

    .warning-list {
      background: #fffbeb;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }

    .warning-list h4 { color: #92400e; margin-bottom: 8px; }
    .warning-list ul { margin-left: 20px; color: #78350f; font-size: 13px; }
    .warning-list li { margin: 4px 0; }

    /* Rest of existing styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 { font-size: 16px; font-weight: 600; }
    .card-body { padding: 20px; }

    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .stat { text-align: center; }
    .stat-value { font-size: 32px; font-weight: 700; }
    .stat-value.green { color: var(--success); }
    .stat-value.yellow { color: var(--warning); }
    .stat-value.red { color: var(--danger); }
    .stat-label { font-size: 12px; color: var(--gray-600); text-transform: uppercase; letter-spacing: 0.05em; }

    .progress-bar { height: 8px; background: var(--gray-200); border-radius: 4px; overflow: hidden; margin-top: 16px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--danger) 0%, var(--warning) 50%, var(--success) 100%); transition: width 0.3s ease; }

    .control-list { list-style: none; }
    .control-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--gray-100); }
    .control-item:last-child { border-bottom: none; }
    .control-status { width: 12px; height: 12px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
    .control-status.green { background: var(--success); }
    .control-status.yellow { background: var(--warning); }
    .control-status.red { background: var(--danger); }
    .control-info { flex-grow: 1; }
    .control-name { font-weight: 500; font-size: 14px; }
    .control-citation { font-size: 12px; color: var(--gray-600); }
    .control-evidence { text-align: right; font-size: 12px; color: var(--gray-600); }

    .case-card { background: var(--gray-50); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .case-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .case-name { font-weight: 600; font-size: 14px; }
    .case-amount { font-weight: 700; color: var(--danger); }
    .case-violations { font-size: 12px; color: var(--gray-600); }

    .action-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: background 0.2s; }
    .action-btn:hover { background: #1d4ed8; }
    .action-btn.secondary { background: white; color: var(--gray-800); border: 1px solid var(--gray-200); }
    .action-btn.secondary:hover { background: var(--gray-50); }

    .upload-zone { border: 2px dashed var(--gray-200); border-radius: 8px; padding: 32px; text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; }
    .upload-zone:hover { border-color: var(--primary); background: #eff6ff; }
    .upload-icon { font-size: 48px; margin-bottom: 8px; }
    .upload-text { color: var(--gray-600); font-size: 14px; }

    .testing-cadence { display: flex; gap: 8px; flex-wrap: wrap; }
    .cadence-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px; background: var(--gray-100); }
    .cadence-badge.active { background: #dbeafe; color: var(--primary); }

    .audit-trail-item { padding: 12px 0; border-bottom: 1px solid var(--gray-100); font-size: 13px; }
    .audit-timestamp { color: var(--gray-600); font-size: 11px; }
    .audit-hash { font-family: monospace; font-size: 10px; color: var(--gray-600); margin-top: 4px; }

    /* Jurisdiction-specific styling */
    .gdpr-mode .sec-specific { opacity: 0.5; }
    .sec-mode .gdpr-specific { opacity: 0.5; }

    .retention-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--gray-50);
      border-radius: 6px;
      margin-top: 12px;
      font-size: 12px;
    }

    .retention-indicator.conflict { background: #fee2e2; color: #991b1b; }

    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .stat-grid { grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body class="sec-mode">
  <!-- Jurisdiction Conflict Warning Modal -->
  <div class="modal-overlay" id="jurisdiction-modal">
    <div class="modal">
      <div class="modal-header danger">
        <div class="modal-icon danger">‚ö†Ô∏è</div>
        <div>
          <div class="modal-title">Regulatory Conflict Detected</div>
          <div class="modal-subtitle">Switching jurisdictions may affect data retention policies</div>
        </div>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 16px;">
          You are attempting to switch from <strong id="from-jurisdiction">SEC</strong> to
          <strong id="to-jurisdiction">GDPR</strong> compliance mode. These frameworks have
          <strong>conflicting requirements</strong> for certain data handling operations.
        </p>

        <table class="conflict-table">
          <thead>
            <tr>
              <th>Requirement</th>
              <th class="sec-col">SEC Rule 17a-4</th>
              <th class="gdpr-col">GDPR</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Record Retention</strong></td>
              <td class="sec-col">Must retain 7 years minimum</td>
              <td class="gdpr-col">Must delete on request (Art. 17)</td>
              <td><span class="conflict-badge conflict">CONFLICT</span></td>
            </tr>
            <tr>
              <td><strong>WORM Storage</strong></td>
              <td class="sec-col">Required (non-rewritable)</td>
              <td class="gdpr-col">Must allow deletion</td>
              <td><span class="conflict-badge conflict">CONFLICT</span></td>
            </tr>
            <tr>
              <td><strong>Audit Trail</strong></td>
              <td class="sec-col">Immutable, complete</td>
              <td class="gdpr-col">May require anonymization</td>
              <td><span class="conflict-badge conflict">CONFLICT</span></td>
            </tr>
            <tr>
              <td><strong>Data Access</strong></td>
              <td class="sec-col">Examiner access required</td>
              <td class="gdpr-col">Subject access rights</td>
              <td><span class="conflict-badge ok">Compatible</span></td>
            </tr>
            <tr>
              <td><strong>Encryption</strong></td>
              <td class="sec-col">Recommended</td>
              <td class="gdpr-col">Required (Art. 32)</td>
              <td><span class="conflict-badge ok">Compatible</span></td>
            </tr>
          </tbody>
        </table>

        <div class="warning-list">
          <h4>‚ö†Ô∏è If you proceed to GDPR mode:</h4>
          <ul>
            <li>Data deletion requests will be <strong>logged but not executed</strong> for SEC-regulated records</li>
            <li>You must maintain <strong>dual retention policies</strong> with legal counsel approval</li>
            <li>EU data subjects will receive a <strong>regulatory exception notice</strong> explaining the conflict</li>
            <li>All conflicts will be <strong>documented in the audit trail</strong> for examiner review</li>
          </ul>
        </div>

        <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; margin-top: 16px;">
          <h4 style="color: #166534; margin-bottom: 8px;">Recommended Approach</h4>
          <p style="font-size: 13px; color: #15803d;">
            For firms handling both US securities and EU clients: Maintain <strong>SEC mode as primary</strong>
            with GDPR supplemental controls. Document the regulatory exception under GDPR Article 17(3)(b)
            which permits retention "for compliance with a legal obligation."
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="cancelJurisdictionSwitch()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmJurisdictionSwitch()">
          I Understand - Switch to <span id="confirm-jurisdiction">GDPR</span>
        </button>
      </div>
    </div>
  </div>

  <header>
    <h1>Compliance Evidence Locker</h1>
    <div class="header-controls">
      <div class="jurisdiction-toggle">
        <button class="jurisdiction-btn sec active" onclick="attemptJurisdictionSwitch('sec')" id="sec-btn">
          üá∫üá∏ SEC
        </button>
        <button class="jurisdiction-btn gdpr" onclick="attemptJurisdictionSwitch('gdpr')" id="gdpr-btn">
          üá™üá∫ GDPR
        </button>
      </div>
      <span class="status-badge green" id="system-status">System Healthy</span>
    </div>
  </header>

  <div class="container">
    <!-- Jurisdiction Alert Banner -->
    <div id="jurisdiction-banner" style="display: none; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; align-items: center; gap: 12px;">
      <span style="font-size: 20px;">‚öñÔ∏è</span>
      <div style="flex-grow: 1;">
        <strong style="color: #92400e;">Dual Jurisdiction Mode Active</strong>
        <p style="font-size: 12px; color: #78350f; margin: 0;">SEC retention requirements take precedence. GDPR deletion requests logged with regulatory exception.</p>
      </div>
      <button class="action-btn secondary" style="font-size: 12px;" onclick="showConflictDetails()">View Conflicts</button>
    </div>

    <!-- Summary Stats -->
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-body">
        <div class="stat-grid">
          <div class="stat">
            <div class="stat-value green" id="satisfied-count">-</div>
            <div class="stat-label">Controls Satisfied</div>
          </div>
          <div class="stat">
            <div class="stat-value yellow" id="pending-count">-</div>
            <div class="stat-label">Pending Review</div>
          </div>
          <div class="stat">
            <div class="stat-value red" id="missing-count">-</div>
            <div class="stat-label">Missing Evidence</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="compliance-progress" style="width: 0%"></div>
        </div>
        <div style="text-align: center; margin-top: 8px; color: var(--gray-600); font-size: 14px;">
          <span id="compliance-percentage">0</span>% Compliant
        </div>
        <div class="retention-indicator" id="retention-indicator">
          <span>üìÅ</span>
          <span><strong>Retention Policy:</strong> <span id="retention-policy">SEC 17a-4 (7 years, WORM storage)</span></span>
        </div>
      </div>
    </div>

    <div class="dashboard-grid">
      <!-- Control Status -->
      <div class="card">
        <div class="card-header">
          <h2>Control Status</h2>
          <button class="action-btn secondary" onclick="refreshStatus()">Refresh</button>
        </div>
        <div class="card-body">
          <ul class="control-list" id="control-list">
            <li class="control-item">
              <div class="control-status green"></div>
              <div class="control-info">
                <div class="control-name">Loading...</div>
                <div class="control-citation">-</div>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <!-- Evidence Upload -->
      <div class="card">
        <div class="card-header">
          <h2>Submit Evidence</h2>
        </div>
        <div class="card-body">
          <div class="upload-zone" id="upload-zone">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">
              Drag files here or click to browse<br>
              <small>PDF, JPG, PNG (max 25MB)</small>
            </div>
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; display: block; margin-bottom: 8px;">Link to Control:</label>
            <select id="control-select" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--gray-200);">
              <option value="">Select a control...</option>
            </select>
          </div>
          <button class="action-btn" style="width: 100%; margin-top: 16px;" onclick="submitEvidence()">
            Submit Evidence
          </button>
        </div>
      </div>

      <!-- Enforcement Case Studies -->
      <div class="card">
        <div class="card-header">
          <h2>Enforcement Case Studies</h2>
        </div>
        <div class="card-body" id="case-studies">
          <div class="case-card">
            <div class="case-header">
              <span class="case-name">GPB Capital Holdings</span>
              <span class="case-amount">$161M+</span>
            </div>
            <div class="case-violations">
              Form D violations, AI verification failures, bad actor checks missing
            </div>
          </div>
          <div class="case-card">
            <div class="case-header">
              <span class="case-name">TNP / Tony Thompson</span>
              <span class="case-amount">$100M+</span>
            </div>
            <div class="case-violations">
              Sponsor fraud, valuation misrepresentation, BD due diligence failures (5yr prison)
            </div>
          </div>
          <div class="case-card">
            <div class="case-header">
              <span class="case-name">American Realty Capital</span>
              <span class="case-amount">$60M+ (BDs)</span>
            </div>
            <div class="case-violations">
              Due diligence failures, ongoing monitoring gaps
            </div>
          </div>
        </div>
      </div>

      <!-- Testing Cadence -->
      <div class="card">
        <div class="card-header">
          <h2>Testing Cadence</h2>
          <span class="status-badge green">Hot DB</span>
        </div>
        <div class="card-body">
          <div style="margin-bottom: 16px;">
            <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px;">Active Schedule</div>
            <div class="testing-cadence">
              <span class="cadence-badge active">Unit: 15min</span>
              <span class="cadence-badge active">Integration: Hourly</span>
              <span class="cadence-badge active">Red Team: Hourly</span>
              <span class="cadence-badge">E2E: 4h</span>
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px;">Last Run Results</div>
            <div style="display: flex; gap: 16px; font-size: 13px;">
              <span style="color: var(--success);">Unit: Passed</span>
              <span style="color: var(--success);">Red Team: Passed</span>
            </div>
          </div>
          <button class="action-btn secondary" style="width: 100%;" onclick="toggleCadence()">
            Configure Cadence
          </button>
        </div>
      </div>

      <!-- Audit Trail -->
      <div class="card" style="grid-column: span 2;">
        <div class="card-header">
          <h2>Audit Trail</h2>
          <button class="action-btn secondary" onclick="exportAudit()">Export</button>
        </div>
        <div class="card-body">
          <div id="audit-trail">
            <div class="audit-trail-item">
              <strong>EVIDENCE_SUBMITTED</strong> - ctrl-ai-verification<br>
              <span class="audit-timestamp">2026-01-21 09:45:23 EST</span>
              <div class="audit-hash">Hash: a1b2c3d4e5f6...</div>
            </div>
            <div class="audit-trail-item">
              <strong>CONTROL_VERIFIED</strong> - ctrl-form-d-filing<br>
              <span class="audit-timestamp">2026-01-21 09:30:00 EST</span>
              <div class="audit-hash">Hash: f6e5d4c3b2a1...</div>
            </div>
            <div class="audit-trail-item">
              <strong>REDTEAM_ANALYSIS</strong> - All schemas passed<br>
              <span class="audit-timestamp">2026-01-21 09:00:00 EST</span>
              <div class="audit-hash">Hash: 9876543210ab...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:3001/api/v1'
      : '/api/v1';

    let authToken = null;
    let currentJurisdiction = 'sec';
    let pendingJurisdiction = null;

    // Jurisdiction Management
    function attemptJurisdictionSwitch(newJurisdiction) {
      if (newJurisdiction === currentJurisdiction) return;

      pendingJurisdiction = newJurisdiction;

      // Update modal content
      document.getElementById('from-jurisdiction').textContent = currentJurisdiction.toUpperCase();
      document.getElementById('to-jurisdiction').textContent = newJurisdiction.toUpperCase();
      document.getElementById('confirm-jurisdiction').textContent = newJurisdiction.toUpperCase();

      // Show warning modal
      document.getElementById('jurisdiction-modal').classList.add('active');
    }

    function cancelJurisdictionSwitch() {
      pendingJurisdiction = null;
      document.getElementById('jurisdiction-modal').classList.remove('active');
    }

    function confirmJurisdictionSwitch() {
      if (!pendingJurisdiction) return;

      currentJurisdiction = pendingJurisdiction;
      pendingJurisdiction = null;

      // Update UI
      document.getElementById('jurisdiction-modal').classList.remove('active');
      document.body.classList.remove('sec-mode', 'gdpr-mode');
      document.body.classList.add(`${currentJurisdiction}-mode`);

      // Update toggle buttons
      document.querySelectorAll('.jurisdiction-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`${currentJurisdiction}-btn`).classList.add('active');

      // Update retention policy display
      updateRetentionPolicy();

      // Show dual jurisdiction banner if switching to GDPR
      if (currentJurisdiction === 'gdpr') {
        document.getElementById('jurisdiction-banner').style.display = 'flex';
      } else {
        document.getElementById('jurisdiction-banner').style.display = 'none';
      }

      // Log the switch in audit trail
      logJurisdictionSwitch();
    }

    function updateRetentionPolicy() {
      const indicator = document.getElementById('retention-indicator');
      const policy = document.getElementById('retention-policy');

      if (currentJurisdiction === 'sec') {
        policy.textContent = 'SEC 17a-4 (7 years, WORM storage)';
        indicator.classList.remove('conflict');
      } else {
        policy.textContent = 'GDPR + SEC Hybrid (Deletion logged, not executed for SEC records)';
        indicator.classList.add('conflict');
      }
    }

    function showConflictDetails() {
      document.getElementById('jurisdiction-modal').classList.add('active');
    }

    function logJurisdictionSwitch() {
      const auditTrail = document.getElementById('audit-trail');
      const entry = document.createElement('div');
      entry.className = 'audit-trail-item';
      entry.innerHTML = `
        <strong>JURISDICTION_SWITCH</strong> - Changed to ${currentJurisdiction.toUpperCase()}<br>
        <span class="audit-timestamp">${new Date().toLocaleString()} EST</span>
        <div class="audit-hash">Hash: ${generateHash()}</div>
      `;
      auditTrail.insertBefore(entry, auditTrail.firstChild);
    }

    function generateHash() {
      return Math.random().toString(16).substr(2, 12) + '...';
    }

    // API Functions
    async function init() {
      try {
        const res = await fetch(`${API_BASE}/auth/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'demo@example.com', role: 'compliance' })
        });
        const data = await res.json();
        authToken = data.token;
        await refreshStatus();
        await loadControls();
      } catch (err) {
        console.log('API not available, using demo data');
        loadDemoData();
      }
    }

    async function refreshStatus() {
      if (!authToken) {
        loadDemoData();
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/compliance-status`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        document.getElementById('satisfied-count').textContent = data.summary.satisfied;
        document.getElementById('missing-count').textContent = data.summary.missing;
        document.getElementById('pending-count').textContent = 0;
        document.getElementById('compliance-percentage').textContent = data.summary.compliancePercentage;
        document.getElementById('compliance-progress').style.width = `${data.summary.compliancePercentage}%`;

        renderControlList(data.controls);
      } catch (err) {
        console.error('Failed to refresh status:', err);
        loadDemoData();
      }
    }

    async function loadControls() {
      if (!authToken) return;

      try {
        const res = await fetch(`${API_BASE}/controls`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        const select = document.getElementById('control-select');
        data.controls.forEach(ctrl => {
          const option = document.createElement('option');
          option.value = ctrl.id;
          option.textContent = `${ctrl.title} (${ctrl.regulationCitation || 'General'})`;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Failed to load controls:', err);
      }
    }

    function renderControlList(controls) {
      const list = document.getElementById('control-list');
      list.innerHTML = controls.slice(0, 8).map(ctrl => `
        <li class="control-item">
          <div class="control-status ${ctrl.status === 'SATISFIED' ? 'green' : 'red'}"></div>
          <div class="control-info">
            <div class="control-name">${ctrl.title}</div>
            <div class="control-citation">${ctrl.regulationCitation || '-'}</div>
          </div>
          <div class="control-evidence">${ctrl.evidenceCount} docs</div>
        </li>
      `).join('');
    }

    function loadDemoData() {
      document.getElementById('satisfied-count').textContent = '18';
      document.getElementById('missing-count').textContent = '5';
      document.getElementById('pending-count').textContent = '2';
      document.getElementById('compliance-percentage').textContent = '72';
      document.getElementById('compliance-progress').style.width = '72%';

      const demoControls = [
        { title: 'Accredited Investor Verification', citation: '17 CFR 230.501(a)', status: 'SATISFIED', count: 47 },
        { title: 'Form D Filing', citation: '17 CFR 230.503', status: 'SATISFIED', count: 2 },
        { title: 'Bad Actor Disqualification', citation: '17 CFR 230.506(d)', status: 'SATISFIED', count: 12 },
        { title: 'Income Verification', citation: '17 CFR 230.501(a)(6)', status: 'SATISFIED', count: 23 },
        { title: 'Net Worth Verification', citation: '17 CFR 230.501(a)(5)', status: 'MISSING', count: 0 },
        { title: 'General Solicitation Compliance', citation: '17 CFR 230.502(c)', status: 'SATISFIED', count: 5 },
        { title: 'Investor Records Retention', citation: 'Record-keeping', status: 'MISSING', count: 0 },
        { title: 'Offering Materials', citation: 'Documentation', status: 'SATISFIED', count: 8 }
      ];

      const list = document.getElementById('control-list');
      list.innerHTML = demoControls.map(ctrl => `
        <li class="control-item">
          <div class="control-status ${ctrl.status === 'SATISFIED' ? 'green' : 'red'}"></div>
          <div class="control-info">
            <div class="control-name">${ctrl.title}</div>
            <div class="control-citation">${ctrl.citation}</div>
          </div>
          <div class="control-evidence">${ctrl.count} docs</div>
        </li>
      `).join('');

      const select = document.getElementById('control-select');
      select.innerHTML = '<option value="">Select a control...</option>';
      demoControls.forEach(ctrl => {
        const option = document.createElement('option');
        option.value = ctrl.title.toLowerCase().replace(/\s+/g, '-');
        option.textContent = `${ctrl.title} (${ctrl.citation})`;
        select.appendChild(option);
      });
    }

    function submitEvidence() {
      const controlId = document.getElementById('control-select').value;
      if (!controlId) {
        alert('Please select a control to link evidence to.');
        return;
      }
      alert(`Evidence submission would upload to S3 and create hash in production.\n\nControl: ${controlId}\nJurisdiction: ${currentJurisdiction.toUpperCase()}\nRetention: ${currentJurisdiction === 'sec' ? '7 years WORM' : 'GDPR + SEC Hybrid'}`);
    }

    function toggleCadence() {
      alert('Cadence configuration would allow toggling between:\n\n- Hot DB: Unit tests every 15min, Red Team hourly\n- Cold DB: Unit tests every 6h, Red Team daily\n- Custom: User-defined CRON expressions');
    }

    function exportAudit() {
      alert(`Audit export would generate:\n\n1. PDF report with all audit entries\n2. Merkle proofs for verification\n3. Signed JSON export for archival\n\nJurisdiction: ${currentJurisdiction.toUpperCase()}`);
    }

    // Initialize
    init();
  </script>
</body>
</html>
